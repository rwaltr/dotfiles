#!/usr/bin/env bash
# vi: ft=sh
# rwaltrctl-init — post-chezmoi-apply setup wizard
# Walks through all manual configuration steps needed after a fresh chezmoi apply.
# Uses gum for a polished TUI experience, falls back to plain prompts.
#
# Usage:
#   rwaltrctl-init          # interactive wizard
#   rwaltrctl-init --force  # no prompts — run everything
#   rwaltrctl-init --status # show current setup status

{{ if (and (eq .chezmoi.os "linux") (not .headless)) -}}
set -euo pipefail

FORCE=false
STATUS=false
case "${1:-}" in
--force) FORCE=true ;;
--status) STATUS=true ;;
esac

HAS_GUM=false
command -v gum &>/dev/null && HAS_GUM=true

BISYNC_DIR="{{ .chezmoi.homeDir }}/.config/bisync"

# ── TUI helpers (gum with plain fallback) ─────────────────────────────────────

header() {
	if $HAS_GUM; then
		gum style --border double --border-foreground 99 --padding "1 3" --margin "1 0" \
			"$(gum format -- "# rwaltrctl-init" "Post chezmoi-apply setup wizard")"
	else
		echo ""
		echo "══════════════════════════════════════════"
		echo "  rwaltrctl-init — setup wizard"
		echo "  Post chezmoi-apply configuration"
		echo "══════════════════════════════════════════"
		echo ""
	fi
}

log_info()  { if $HAS_GUM; then gum log --level info "$@";  else echo "[info]  $*"; fi; }
log_warn()  { if $HAS_GUM; then gum log --level warn "$@";  else echo "[warn]  $*"; fi; }
log_error() { if $HAS_GUM; then gum log --level error "$@"; else echo "[error] $*" >&2; fi; }
log_done()  { if $HAS_GUM; then gum log --level info "✓ $*"; else echo "[✓] $*"; fi; }

step_header() {
	if $HAS_GUM; then
		echo ""
		gum style --foreground 99 --bold "▸ $*"
	else
		echo ""
		echo "── $* ──"
	fi
}

confirm() {
	if $FORCE; then return 0; fi
	if $HAS_GUM; then
		gum confirm "$1"
	else
		local answer
		read -rp "$1 [y/N] " answer
		[[ "$answer" =~ ^[Yy] ]]
	fi
}

spin() {
	local title="$1"; shift
	if $HAS_GUM; then
		gum spin --spinner dot --title "$title" --show-error -- "$@"
	else
		echo "$title"
		"$@"
	fi
}

password_input() {
	local prompt="${1:-Password:}"
	if $HAS_GUM; then
		gum input --password --placeholder "$prompt"
	else
		local pw
		read -rsp "$prompt " pw
		echo ""  >&2
		echo "$pw"
	fi
}

wait_enter() {
	if $FORCE; then return; fi
	if $HAS_GUM; then
		gum input --placeholder "Press Enter to continue..." > /dev/null
	else
		read -rp "Press Enter to continue..."
	fi
}

# ── Status checks ─────────────────────────────────────────────────────────────

is_tailscale_up() {
	command -v tailscale &>/dev/null && tailscale status &>/dev/null
}

is_1password_signed_in() {
	command -v op &>/dev/null && op account list 2>/dev/null | grep -q '.'
}

is_gh_authed() {
	command -v gh &>/dev/null && gh auth status &>/dev/null 2>&1
}

is_restic_creds_set() {
	[[ -s "{{ .chezmoi.homeDir }}/.config/resticprofile/password" ]]
}

is_restic_timer_enabled() {
	systemctl --user is-enabled resticprofile@home.timer &>/dev/null 2>&1
}

is_bisync_service_enabled() {
	local name="$1"
	systemctl --user is-enabled "bisync@${name}.service" &>/dev/null 2>&1
}

is_bisync_resynced() {
	local lock_dir="{{ .chezmoi.homeDir }}/.cache/rclone/bisync"
	[[ -d "$lock_dir" ]] && [[ -n "$(ls -A "$lock_dir" 2>/dev/null)" ]]
}

get_bisync_configs() {
	local -a configs=()
	if [[ -d "$BISYNC_DIR" ]]; then
		for f in "$BISYNC_DIR"/*.env; do
			[[ -f "$f" ]] || continue
			configs+=("$(basename "$f" .env)")
		done
	fi
	echo "${configs[@]}"
}

# ── Status display ────────────────────────────────────────────────────────────

status_line() {
	local done="$1" label="$2"
	if $HAS_GUM; then
		if [[ "$done" == "true" ]]; then
			echo "  $(gum style --foreground 82 '✓') $label"
		else
			echo "  $(gum style --foreground 214 '○') $label"
		fi
	else
		if [[ "$done" == "true" ]]; then
			echo "  ✓ $label"
		else
			echo "  ○ $label"
		fi
	fi
}

show_status() {
	echo ""
	if $HAS_GUM; then
		gum style --bold "Setup Status"
	else
		echo "Setup Status"
	fi
	echo ""

	if is_tailscale_up;         then status_line true  "Tailscale: connected";       else status_line false "Tailscale: not connected"; fi
	if is_1password_signed_in;  then status_line true  "1Password: signed in";       else status_line false "1Password: not signed in"; fi
	if is_gh_authed;            then status_line true  "GitHub CLI: authenticated";  else status_line false "GitHub CLI: not authenticated"; fi
	if is_restic_creds_set;     then status_line true  "Restic credentials: set";    else status_line false "Restic credentials: not set"; fi
	if is_restic_timer_enabled; then status_line true  "Restic timer: enabled";      else status_line false "Restic timer: not enabled"; fi
	if is_bisync_resynced;      then status_line true  "Bisync: initialized";        else status_line false "Bisync: not initialized"; fi

	local configs
	read -ra configs <<< "$(get_bisync_configs)"
	if [[ ${#configs[@]} -gt 0 ]]; then
		for name in "${configs[@]}"; do
			if is_bisync_service_enabled "$name"; then
				status_line true  "Bisync service ($name): enabled"
			else
				status_line false "Bisync service ($name): not enabled"
			fi
		done
	fi
	echo ""
}

if $STATUS; then
	show_status
	exit 0
fi

# ── Build choice list ─────────────────────────────────────────────────────────

header
show_status

# Build options for gum choose / manual selection
declare -A STEPS
declare -a STEP_ORDER=()

add_step() {
	local key="$1" label="$2" done="$3"
	if [[ "$done" == "true" ]]; then
		STEPS[$key]="↻ $label (redo)"
	else
		STEPS[$key]="$label"
	fi
	STEP_ORDER+=("$key")
}

if is_tailscale_up;         then add_step tailscale    "Connect to Tailscale"            true
else                             add_step tailscale    "Connect to Tailscale"            false; fi

if is_1password_signed_in;  then add_step 1password    "Sign in to 1Password"            true
else                             add_step 1password    "Sign in to 1Password"            false; fi

if is_gh_authed;            then add_step gh           "Authenticate GitHub CLI"         true
else                             add_step gh           "Authenticate GitHub CLI"         false; fi

if is_restic_creds_set;     then add_step restic_creds "Set up restic backup credentials" true
else                             add_step restic_creds "Set up restic backup credentials" false; fi

if is_restic_timer_enabled; then add_step restic_timer "Enable restic backup timer"      true
else                             add_step restic_timer "Enable restic backup timer"      false; fi

if is_bisync_resynced;      then add_step bisync_init  "Initialize bisync (first resync)" true
else                             add_step bisync_init  "Initialize bisync (first resync)" false; fi

BISYNC_CONFIGS=()
read -ra BISYNC_CONFIGS <<< "$(get_bisync_configs)"
for name in "${BISYNC_CONFIGS[@]}"; do
	if is_bisync_service_enabled "$name"; then
		add_step "bisync_svc_${name}" "Enable bisync service: ${name}" true
	else
		add_step "bisync_svc_${name}" "Enable bisync service: ${name}" false
	fi
done

# ── Select steps ──────────────────────────────────────────────────────────────

declare -A SELECTED
SELECTED_COUNT=0

if $FORCE; then
	for key in "${STEP_ORDER[@]}"; do
		SELECTED[$key]=true
		((SELECTED_COUNT++))
	done
else
	if $HAS_GUM; then
		# Build display labels for gum choose
		LABELS=()
		for key in "${STEP_ORDER[@]}"; do
			LABELS+=("${STEPS[$key]}")
		done

		CHOSEN=$(printf '%s\n' "${LABELS[@]}" | \
			gum choose --no-limit \
				--header "Select steps to run (space to toggle, enter to confirm):" \
				--height "$((${#LABELS[@]} + 2))" \
			|| true)

		# Map chosen labels back to keys
		while IFS= read -r line; do
			[[ -z "$line" ]] && continue
			for key in "${STEP_ORDER[@]}"; do
				if [[ "${STEPS[$key]}" == "$line" ]]; then
					SELECTED[$key]=true
					((SELECTED_COUNT++))
					break
				fi
			done
		done <<< "$CHOSEN"
	else
		# Plain fallback: ask per step
		for key in "${STEP_ORDER[@]}"; do
			label="${STEPS[$key]}"
			if confirm "$label?"; then
				SELECTED[$key]=true
				((SELECTED_COUNT++))
			fi
		done
	fi
fi

if [[ $SELECTED_COUNT -eq 0 ]]; then
	log_info "Nothing selected — all done!"
	exit 0
fi

if ! $FORCE; then
	echo ""
	if $HAS_GUM; then
		gum style --foreground 99 "${SELECTED_COUNT} step(s) selected"
	else
		echo "${SELECTED_COUNT} step(s) selected"
	fi
	confirm "Begin setup?" || { log_info "Aborted."; exit 0; }
fi

# ── Execute steps ─────────────────────────────────────────────────────────────

# Tailscale
if [[ "${SELECTED[tailscale]:-}" == "true" ]]; then
	step_header "Tailscale"
	if ! command -v tailscale &>/dev/null; then
		log_error "tailscale not installed — run chezmoi apply first"
	else
		log_info "Starting Tailscale login..."
		sudo tailscale up
		if is_tailscale_up; then log_done "Tailscale connected"
		else log_warn "Tailscale login may not have completed"; fi
	fi
fi

# 1Password
if [[ "${SELECTED[1password]:-}" == "true" ]]; then
	step_header "1Password"
	if $HAS_GUM; then
		gum format -- \
			"Open the **1Password desktop app** and sign in." \
			"" \
			"The CLI authenticates via the desktop app's socket." \
			"" \
			"    flatpak run com.onepassword.OnePassword" \
			"" \
			"After signing in, enable in **Settings → Developer**:" \
			"- CLI integration" \
			"- SSH agent"
	else
		echo "Open the 1Password desktop app and sign in."
		echo "  App: flatpak run com.onepassword.OnePassword"
		echo "After signing in, enable: Settings → Developer → CLI integration + SSH agent"
	fi
	echo ""
	wait_enter
	if is_1password_signed_in; then log_done "1Password CLI connected"
	else log_warn "1Password CLI not yet connected — finish setup in the app"; fi
fi

# GitHub CLI
if [[ "${SELECTED[gh]:-}" == "true" ]]; then
	step_header "GitHub CLI"
	log_info "Authenticating with GitHub..."
	gh auth login
	if is_gh_authed; then log_done "GitHub CLI authenticated"
	else log_warn "GitHub auth may not have completed"; fi
fi

# Restic credentials
if [[ "${SELECTED[restic_creds]:-}" == "true" ]]; then
	step_header "Restic backup credentials"

	CRED_DIR="{{ .chezmoi.homeDir }}/.config/resticprofile"
	PASS_FILE="${CRED_DIR}/password"

	if [[ -s "$PASS_FILE" ]]; then
		log_warn "Password file exists ($(wc -c < "$PASS_FILE") bytes)"
		if ! confirm "Overwrite existing credentials?"; then
			log_info "Keeping existing credentials"
		else
			_do_restic_creds=true
		fi
	elif [[ -f "$PASS_FILE" ]]; then
		log_warn "Found empty password file — replacing"
		rm -f "$PASS_FILE"
		_do_restic_creds=true
	else
		_do_restic_creds=true
	fi

	if [[ "${_do_restic_creds:-}" == "true" ]]; then
		mkdir -p "$CRED_DIR"
		chmod 700 "$CRED_DIR"

		password=$(password_input "Restic repo password")
		password_confirm=$(password_input "Confirm password")

		if [[ "$password" != "$password_confirm" ]]; then
			log_error "Passwords do not match"
		elif [[ -z "$password" ]]; then
			log_error "Password cannot be empty"
		else
			printf '%s' "$password" > "$PASS_FILE"
			chmod 600 "$PASS_FILE"
			log_done "Restic credentials configured"
		fi
	fi
fi

# Restic timer
if [[ "${SELECTED[restic_timer]:-}" == "true" ]]; then
	step_header "Restic backup timer"
	log_info "Enabling resticprofile@home.timer..."
	systemctl --user enable --now resticprofile@home.timer
	log_done "Restic backup timer enabled (hourly)"
fi

# Bisync initial resync
if [[ "${SELECTED[bisync_init]:-}" == "true" ]]; then
	step_header "Bisync initial resync"
	if ! is_tailscale_up; then
		log_warn "Tailscale not connected — bisync needs network to the remote"
		log_warn "Skipping — connect Tailscale first, then re-run"
	else
		for name in "${BISYNC_CONFIGS[@]}"; do
			LOCAL="" REMOTE=""
			# shellcheck source=/dev/null
			source "$BISYNC_DIR/${name}.env"

			if [[ -z "${LOCAL:-}" || -z "${REMOTE:-}" ]]; then
				log_warn "$name: missing LOCAL or REMOTE in ${name}.env, skipping"
				continue
			fi

			log_info "Resyncing $name: $LOCAL ↔ $REMOTE"
			if $HAS_GUM; then
				gum spin --spinner dot --title "Resyncing $name..." --show-error -- \
					auto-bisync "$LOCAL" "$REMOTE" resync || log_warn "$name: resync failed"
			else
				auto-bisync "$LOCAL" "$REMOTE" resync || log_warn "$name: resync failed"
			fi
		done

		if is_bisync_resynced; then log_done "Bisync initial resync complete"
		else log_warn "Resync may not have completed"; fi
	fi
fi

# Bisync services
for name in "${BISYNC_CONFIGS[@]}"; do
	if [[ "${SELECTED[bisync_svc_${name}]:-}" == "true" ]]; then
		step_header "Enable bisync service: $name"
		if ! is_bisync_resynced; then
			log_warn "Bisync not initialized — run initial resync first"
		else
			log_info "Enabling bisync@${name}.service..."
			systemctl --user enable --now "bisync@${name}.service"
			log_done "bisync@${name}.service enabled (continuous sync)"
		fi
	fi
done

# ── Summary ───────────────────────────────────────────────────────────────────

show_status

if $HAS_GUM; then
	gum style --foreground 82 --bold "Setup wizard complete."
else
	echo "Setup wizard complete."
fi

{{- else }}
echo "Skipping init wizard (not Linux or headless)"
{{- end }}
