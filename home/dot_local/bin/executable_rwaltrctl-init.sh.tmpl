#!/usr/bin/env bash
# vi: ft=sh
# rwaltrctl-init — post-chezmoi-apply setup wizard
# Walks through all manual configuration steps needed after a fresh chezmoi apply.
# Idempotent — safe to re-run; skips steps that are already configured.
#
# Usage:
#   rwaltrctl-init          # interactive wizard
#   rwaltrctl-init --force  # no prompts — run everything
#   rwaltrctl-init --status # show current setup status

{{ if (and (eq .chezmoi.os "linux") (not .headless)) -}}
set -euo pipefail

FORCE=false
STATUS=false
case "${1:-}" in
--force) FORCE=true ;;
--status) STATUS=true ;;
esac

# ── Colors & helpers ──────────────────────────────────────────────────────────
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

BISYNC_DIR="{{ .chezmoi.homeDir }}/.config/bisync"

info()  { echo -e "${GREEN}[init]${NC} $*"; }
warn()  { echo -e "${YELLOW}[init]${NC} $*"; }
error() { echo -e "${RED}[init]${NC} $*" >&2; }
step()  { echo -e "${CYAN}${BOLD}══ $* ══${NC}"; }

check_done() { echo -e "  ${GREEN}✓${NC} $*"; }
check_todo() { echo -e "  ${YELLOW}○${NC} $*"; }
check_skip() { echo -e "  ${DIM}─ $* (skipped)${NC}"; }

confirm() {
	if $FORCE; then return 0; fi
	local msg="$1"
	read -rp "$(echo -e "${YELLOW}$msg [y/N]${NC} ")" answer
	[[ "$answer" =~ ^[Yy] ]]
}

wait_enter() {
	if $FORCE; then return 0; fi
	read -rp "$(echo -e "${DIM}Press Enter to continue...${NC}")"
}

# ── Status checks ─────────────────────────────────────────────────────────────
is_tailscale_up() {
	command -v tailscale &>/dev/null && tailscale status &>/dev/null
}

is_1password_signed_in() {
	command -v op &>/dev/null && op account list 2>/dev/null | grep -q '.'
}

is_gh_authed() {
	command -v gh &>/dev/null && gh auth status &>/dev/null 2>&1
}

is_restic_creds_set() {
	[[ -f "{{ .chezmoi.homeDir }}/.config/resticprofile/password" ]]
}

is_restic_timer_enabled() {
	systemctl --user is-enabled resticprofile@home.timer &>/dev/null 2>&1
}

is_bisync_service_enabled() {
	local name="$1"
	systemctl --user is-enabled "bisync@${name}.service" &>/dev/null 2>&1
}

is_bisync_resynced() {
	local lock_dir="{{ .chezmoi.homeDir }}/.cache/rclone/bisync"
	[[ -d "$lock_dir" ]] && [[ -n "$(ls -A "$lock_dir" 2>/dev/null)" ]]
}

# Discover bisync configs from ~/.config/bisync/*.env
get_bisync_configs() {
	local -a configs=()
	if [[ -d "$BISYNC_DIR" ]]; then
		for f in "$BISYNC_DIR"/*.env; do
			[[ -f "$f" ]] || continue
			configs+=("$(basename "$f" .env)")
		done
	fi
	echo "${configs[@]}"
}

# ── Status display ────────────────────────────────────────────────────────────
show_status() {
	echo ""
	echo -e "${BOLD}rwaltrctl-init — setup status${NC}"
	echo ""

	if is_tailscale_up;         then check_done "Tailscale: connected";       else check_todo "Tailscale: not connected"; fi
	if is_1password_signed_in;  then check_done "1Password: signed in";       else check_todo "1Password: not signed in"; fi
	if is_gh_authed;            then check_done "GitHub CLI: authenticated";  else check_todo "GitHub CLI: not authenticated"; fi
	if is_restic_creds_set;     then check_done "Restic credentials: set";    else check_todo "Restic credentials: not set"; fi
	if is_restic_timer_enabled; then check_done "Restic timer: enabled";      else check_todo "Restic timer: not enabled"; fi

	# Bisync status per config
	if is_bisync_resynced; then check_done "Bisync: initialized"; else check_todo "Bisync: not initialized"; fi
	local configs
	read -ra configs <<< "$(get_bisync_configs)"
	if [[ ${#configs[@]} -gt 0 ]]; then
		for name in "${configs[@]}"; do
			if is_bisync_service_enabled "$name"; then
				check_done "Bisync service ($name): enabled"
			else
				check_todo "Bisync service ($name): not enabled"
			fi
		done
	else
		check_skip "Bisync: no configs in $BISYNC_DIR"
	fi
	echo ""
}

if $STATUS; then
	show_status
	exit 0
fi

# ── Wizard questions ──────────────────────────────────────────────────────────
echo ""
echo -e "${CYAN}╔══════════════════════════════════════════════════════╗${NC}"
echo -e "${CYAN}║          rwaltrctl-init — setup wizard              ║${NC}"
echo -e "${CYAN}║  Post chezmoi-apply configuration for a new host.   ║${NC}"
echo -e "${CYAN}╚══════════════════════════════════════════════════════╝${NC}"
echo ""

show_status

RUN_TAILSCALE=false
RUN_1PASSWORD=false
RUN_GH=false
RUN_RESTIC=false
RUN_RESTIC_TIMER=false
RUN_BISYNC_RESYNC=false
# Associative array for per-config bisync enable choices
declare -A RUN_BISYNC_ENABLE

# Discover bisync configs
BISYNC_CONFIGS=()
read -ra BISYNC_CONFIGS <<< "$(get_bisync_configs)"

if $FORCE; then
	RUN_TAILSCALE=true
	RUN_1PASSWORD=true
	RUN_GH=true
	RUN_RESTIC=true
	RUN_RESTIC_TIMER=true
	RUN_BISYNC_RESYNC=true
	for name in "${BISYNC_CONFIGS[@]}"; do
		RUN_BISYNC_ENABLE[$name]=true
	done
else
	echo -e "${BOLD}Select steps to run:${NC}"
	echo ""

	STEP=1
	! is_tailscale_up        && confirm "$STEP. Connect to Tailscale?"             && RUN_TAILSCALE=true
	  is_tailscale_up        && check_skip "$STEP. Tailscale (already connected)"
	((STEP++))

	! is_1password_signed_in && confirm "$STEP. Sign in to 1Password?"             && RUN_1PASSWORD=true
	  is_1password_signed_in && check_skip "$STEP. 1Password (already signed in)"
	((STEP++))

	! is_gh_authed           && confirm "$STEP. Authenticate GitHub CLI?"          && RUN_GH=true
	  is_gh_authed           && check_skip "$STEP. GitHub CLI (already authed)"
	((STEP++))

	! is_restic_creds_set    && confirm "$STEP. Set up restic backup credentials?" && RUN_RESTIC=true
	  is_restic_creds_set    && check_skip "$STEP. Restic credentials (already set)"
	((STEP++))

	! is_restic_timer_enabled && confirm "$STEP. Enable restic backup timer?"      && RUN_RESTIC_TIMER=true
	  is_restic_timer_enabled && check_skip "$STEP. Restic timer (already enabled)"
	((STEP++))

	! is_bisync_resynced     && confirm "$STEP. Initialize bisync (first resync)?" && RUN_BISYNC_RESYNC=true
	  is_bisync_resynced     && check_skip "$STEP. Bisync init (already resynced)"
	((STEP++))

	if [[ ${#BISYNC_CONFIGS[@]} -gt 0 ]]; then
		for name in "${BISYNC_CONFIGS[@]}"; do
			if ! is_bisync_service_enabled "$name"; then
				confirm "$STEP. Enable bisync service: ${name}?" && RUN_BISYNC_ENABLE[$name]=true
			else
				check_skip "$STEP. Bisync service ($name) (already enabled)"
			fi
			((STEP++))
		done
	fi

	echo ""
fi

# Count selected
SELECTED=0
$RUN_TAILSCALE     && ((SELECTED++)) || true
$RUN_1PASSWORD     && ((SELECTED++)) || true
$RUN_GH            && ((SELECTED++)) || true
$RUN_RESTIC        && ((SELECTED++)) || true
$RUN_RESTIC_TIMER  && ((SELECTED++)) || true
$RUN_BISYNC_RESYNC && ((SELECTED++)) || true
for name in "${!RUN_BISYNC_ENABLE[@]}"; do
	[[ "${RUN_BISYNC_ENABLE[$name]}" == "true" ]] && ((SELECTED++)) || true
done

if [[ $SELECTED -eq 0 ]]; then
	info "Nothing to do — system is fully configured!"
	exit 0
fi

if ! $FORCE; then
	info "$SELECTED step(s) selected."
	confirm "Begin setup?" || { info "Aborted."; exit 0; }
fi

echo ""

# ── Step: Tailscale ───────────────────────────────────────────────────────────
if $RUN_TAILSCALE; then
	step "Tailscale"
	if ! command -v tailscale &>/dev/null; then
		error "tailscale not installed — run chezmoi apply first"
	elif is_tailscale_up; then
		check_done "Already connected"
	else
		info "Starting Tailscale login..."
		sudo tailscale up
		if is_tailscale_up; then
			check_done "Tailscale connected"
		else
			warn "Tailscale login may not have completed — check 'tailscale status'"
		fi
	fi
	echo ""
fi

# ── Step: 1Password ──────────────────────────────────────────────────────────
if $RUN_1PASSWORD; then
	step "1Password"
	if is_1password_signed_in; then
		check_done "Already signed in"
	else
		info "Open the 1Password desktop app and sign in."
		info "The CLI authenticates via the desktop app's socket."
		info "  App: flatpak run com.onepassword.OnePassword"
		info ""
		info "After signing in to the app, enable these in 1Password Settings:"
		info "  → Developer → CLI integration"
		info "  → Developer → SSH agent"
		wait_enter
		if is_1password_signed_in; then
			check_done "1Password CLI connected"
		else
			warn "1Password CLI not yet connected — finish setup in the app"
		fi
	fi
	echo ""
fi

# ── Step: GitHub CLI ──────────────────────────────────────────────────────────
if $RUN_GH; then
	step "GitHub CLI auth"
	if is_gh_authed; then
		check_done "Already authenticated"
	else
		info "Authenticating with GitHub..."
		gh auth login
		if is_gh_authed; then
			check_done "GitHub CLI authenticated"
		else
			warn "GitHub auth may not have completed"
		fi
	fi
	echo ""
fi

# ── Step: Restic credentials ─────────────────────────────────────────────────
if $RUN_RESTIC; then
	step "Restic backup credentials"
	if is_restic_creds_set; then
		check_done "Credentials already set"
	else
		info "Running restic-setup-creds..."
		restic-setup-creds
		if is_restic_creds_set; then
			check_done "Restic credentials configured"
		else
			warn "Credentials not set — run 'restic-setup-creds' manually"
		fi
	fi
	echo ""
fi

# ── Step: Restic timer ───────────────────────────────────────────────────────
if $RUN_RESTIC_TIMER; then
	step "Enable restic backup timer"
	if is_restic_timer_enabled; then
		check_done "Timer already enabled"
	else
		info "Enabling resticprofile@home.timer..."
		systemctl --user enable --now resticprofile@home.timer
		check_done "Restic backup timer enabled (hourly)"
	fi
	echo ""
fi

# ── Step: Bisync initial resync ──────────────────────────────────────────────
if $RUN_BISYNC_RESYNC; then
	step "Bisync initial resync"
	if is_bisync_resynced; then
		check_done "Already initialized"
	elif ! is_tailscale_up; then
		warn "Tailscale not connected — bisync needs network to the remote"
		warn "Skipping — connect Tailscale first, then re-run"
	else
		for name in "${BISYNC_CONFIGS[@]}"; do
			local_path=""
			remote_path=""
			# Source the env file to get LOCAL and REMOTE
			# shellcheck source=/dev/null
			source "$BISYNC_DIR/${name}.env"
			local_path="${LOCAL:-}"
			remote_path="${REMOTE:-}"

			if [[ -z "$local_path" || -z "$remote_path" ]]; then
				warn "  $name: missing LOCAL or REMOTE in ${name}.env, skipping"
				continue
			fi

			info "  Resyncing $name..."
			info "    Local:  $local_path"
			info "    Remote: $remote_path"
			auto-bisync "$local_path" "$remote_path" resync || warn "  $name: resync failed — check output above"
		done

		if is_bisync_resynced; then
			check_done "Bisync initial resync complete"
		else
			warn "Resync may not have completed — check output above"
		fi
	fi
	echo ""
fi

# ── Step: Bisync services ────────────────────────────────────────────────────
for name in "${BISYNC_CONFIGS[@]}"; do
	if [[ "${RUN_BISYNC_ENABLE[$name]:-}" == "true" ]]; then
		step "Enable bisync service: $name"
		if is_bisync_service_enabled "$name"; then
			check_done "Service already enabled"
		elif ! is_bisync_resynced; then
			warn "Bisync not initialized — run initial resync first"
		else
			info "Enabling bisync@${name}.service..."
			systemctl --user enable --now "bisync@${name}.service"
			check_done "bisync@${name}.service enabled (continuous sync)"
		fi
		echo ""
	fi
done

# ── Summary ───────────────────────────────────────────────────────────────────
echo ""
info "Setup wizard complete."
echo ""
show_status

{{- else }}
echo "Skipping init wizard (not Linux or headless)"
{{- end }}
