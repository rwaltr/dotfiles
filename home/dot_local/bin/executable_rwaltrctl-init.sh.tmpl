#!/usr/bin/env bash
# vi: ft=sh
# rwaltrctl-init — post-chezmoi-apply setup wizard
# Walks through manual configuration steps one at a time after a fresh chezmoi apply.
# Idempotent — safe to re-run; completed steps offer a redo option.
#
# Usage:
#   rwaltrctl-init          # interactive wizard
#   rwaltrctl-init --force  # no prompts — run everything
#   rwaltrctl-init --status # show current setup status

{{ if (and (eq .chezmoi.os "linux") (not .headless)) -}}
set -euo pipefail

FORCE=false
STATUS=false
case "${1:-}" in
--force) FORCE=true ;;
--status) STATUS=true ;;
esac

BISYNC_DIR="{{ .chezmoi.homeDir }}/.config/bisync"

# ── Colors & helpers ──────────────────────────────────────────────────────────
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

info()  { echo -e "${GREEN}[init]${NC} $*"; }
warn()  { echo -e "${YELLOW}[init]${NC} $*"; }
error() { echo -e "${RED}[init]${NC} $*" >&2; }
step_header() { echo -e "\n${CYAN}${BOLD}══ $* ══${NC}"; }

check_done() { echo -e "  ${GREEN}✓${NC} $*"; }
check_todo() { echo -e "  ${YELLOW}○${NC} $*"; }

confirm() {
	if $FORCE; then return 0; fi
	local msg="$1"
	read -rp "$(echo -e "${YELLOW}$msg [y/N]${NC} ")" answer
	[[ "$answer" =~ ^[Yy] ]]
}

# Ask for a step: if done, offer redo; if not done, ask to run.
ask_step() {
	local done="$1" desc="$2" done_desc="$3"
	if $FORCE; then return 0; fi
	if [[ "$done" == "true" ]]; then
		confirm "$done_desc — redo?"
	else
		confirm "$desc?"
	fi
}

wait_enter() {
	if $FORCE; then return; fi
	read -rp "$(echo -e "${DIM}Press Enter to continue...${NC}")"
}

# ── Status checks ─────────────────────────────────────────────────────────────
is_tailscale_up() {
	command -v tailscale &>/dev/null && tailscale status &>/dev/null
}

is_1password_signed_in() {
	command -v op &>/dev/null && op account list 2>/dev/null | grep -q '.'
}

is_gh_authed() {
	command -v gh &>/dev/null && gh auth status &>/dev/null 2>&1
}

is_restic_creds_set() {
	[[ -s "{{ .chezmoi.homeDir }}/.config/resticprofile/password" ]]
}

is_restic_timer_enabled() {
	systemctl --user is-enabled resticprofile@home.timer &>/dev/null 2>&1
}

is_bisync_service_enabled() {
	local name="$1"
	systemctl --user is-enabled "bisync@${name}.service" &>/dev/null 2>&1
}

is_bisync_resynced() {
	local lock_dir="{{ .chezmoi.homeDir }}/.cache/rclone/bisync"
	[[ -d "$lock_dir" ]] && [[ -n "$(ls -A "$lock_dir" 2>/dev/null)" ]]
}

get_bisync_configs() {
	local -a configs=()
	if [[ -d "$BISYNC_DIR" ]]; then
		for f in "$BISYNC_DIR"/*.env; do
			[[ -f "$f" ]] || continue
			configs+=("$(basename "$f" .env)")
		done
	fi
	echo "${configs[@]}"
}

# ── Status display ────────────────────────────────────────────────────────────
show_status() {
	echo ""
	echo -e "${BOLD}rwaltrctl-init — setup status${NC}"
	echo ""

	if is_tailscale_up;         then check_done "Tailscale: connected";       else check_todo "Tailscale: not connected"; fi
	if is_1password_signed_in;  then check_done "1Password: signed in";       else check_todo "1Password: not signed in"; fi
	if is_gh_authed;            then check_done "GitHub CLI: authenticated";  else check_todo "GitHub CLI: not authenticated"; fi
	if is_restic_creds_set;     then check_done "Restic credentials: set";    else check_todo "Restic credentials: not set"; fi
	if is_restic_timer_enabled; then check_done "Restic timer: enabled";      else check_todo "Restic timer: not enabled"; fi

	local configs
	read -ra configs <<< "$(get_bisync_configs)"
	if [[ ${#configs[@]} -gt 0 ]]; then
		if is_bisync_resynced; then check_done "Bisync: initialized"; else check_todo "Bisync: not initialized"; fi
		for name in "${configs[@]}"; do
			if is_bisync_service_enabled "$name"; then
				check_done "Bisync service ($name): enabled"
			else
				check_todo "Bisync service ($name): not enabled"
			fi
		done
	fi
	echo ""
}

if $STATUS; then
	show_status
	exit 0
fi

# ── Header ────────────────────────────────────────────────────────────────────
echo ""
echo -e "${CYAN}╔══════════════════════════════════════════════════════╗${NC}"
echo -e "${CYAN}║          rwaltrctl-init — setup wizard              ║${NC}"
echo -e "${CYAN}║  Post chezmoi-apply configuration for a new host.   ║${NC}"
echo -e "${CYAN}╚══════════════════════════════════════════════════════╝${NC}"

show_status

BISYNC_CONFIGS=()
read -ra BISYNC_CONFIGS <<< "$(get_bisync_configs)"

# ── Step 1: Tailscale ────────────────────────────────────────────────────────
if is_tailscale_up; then DONE=true; else DONE=false; fi
if ask_step "$DONE" "Connect to Tailscale" "Tailscale (connected)"; then
	step_header "Tailscale"
	if ! command -v tailscale &>/dev/null; then
		error "tailscale not installed — run chezmoi apply first"
	else
		info "Starting Tailscale login..."
		sudo tailscale up
		if is_tailscale_up; then check_done "Tailscale connected"
		else warn "Tailscale login may not have completed — check 'tailscale status'"; fi
	fi
fi

# ── Step 2: 1Password ────────────────────────────────────────────────────────
if is_1password_signed_in; then DONE=true; else DONE=false; fi
if ask_step "$DONE" "Sign in to 1Password" "1Password (signed in)"; then
	step_header "1Password"
	info "Open the 1Password desktop app and sign in."
	info "The CLI authenticates via the desktop app's socket."
	info "  App: flatpak run com.onepassword.OnePassword"
	info ""
	info "After signing in to the app, enable these in 1Password Settings:"
	info "  → Developer → CLI integration"
	info "  → Developer → SSH agent"
	wait_enter
	if is_1password_signed_in; then check_done "1Password CLI connected"
	else warn "1Password CLI not yet connected — finish setup in the app"; fi
fi

# ── Step 3: GitHub CLI ────────────────────────────────────────────────────────
if is_gh_authed; then DONE=true; else DONE=false; fi
if ask_step "$DONE" "Authenticate GitHub CLI" "GitHub CLI (authenticated)"; then
	step_header "GitHub CLI"
	info "Authenticating with GitHub..."
	gh auth login
	if is_gh_authed; then check_done "GitHub CLI authenticated"
	else warn "GitHub auth may not have completed"; fi
fi

# ── Step 4: Restic credentials ───────────────────────────────────────────────
if is_restic_creds_set; then DONE=true; else DONE=false; fi
if ask_step "$DONE" "Set up restic backup credentials" "Restic credentials (set)"; then
	step_header "Restic backup credentials"

	CRED_DIR="{{ .chezmoi.homeDir }}/.config/resticprofile"
	PASS_FILE="${CRED_DIR}/password"

	do_creds=true
	if [[ -s "$PASS_FILE" ]]; then
		warn "Password file exists ($(wc -c < "$PASS_FILE") bytes)"
		confirm "Overwrite existing credentials?" || do_creds=false
	elif [[ -f "$PASS_FILE" ]]; then
		warn "Found empty password file — replacing"
		rm -f "$PASS_FILE"
	fi

	if $do_creds; then
		mkdir -p "$CRED_DIR"
		chmod 700 "$CRED_DIR"

		read -rsp "Restic repo password: " password; echo ""
		read -rsp "Confirm password: " password_confirm; echo ""

		if [[ "$password" != "$password_confirm" ]]; then
			error "Passwords do not match"
		elif [[ -z "$password" ]]; then
			error "Password cannot be empty"
		else
			printf '%s' "$password" > "$PASS_FILE"
			chmod 600 "$PASS_FILE"
			check_done "Restic credentials configured"
		fi
	fi
fi

# ── Step 5: Restic timer ─────────────────────────────────────────────────────
if is_restic_timer_enabled; then DONE=true; else DONE=false; fi
if ask_step "$DONE" "Enable restic backup timer" "Restic timer (enabled)"; then
	step_header "Restic backup timer"
	info "Enabling resticprofile@home.timer..."
	systemctl --user enable --now resticprofile@home.timer
	check_done "Restic backup timer enabled (hourly)"
fi

# ── Step 6+: Bisync initial resync (per config) ─────────────────────────────
for name in "${BISYNC_CONFIGS[@]}"; do
	if is_bisync_resynced; then DONE=true; else DONE=false; fi
	if ask_step "$DONE" "Initial bisync resync: ${name}" "Bisync resync ($name) (initialized)"; then
		step_header "Bisync resync: $name"
		if ! is_tailscale_up; then
			warn "Tailscale not connected — bisync needs network to the remote"
			warn "Skipping — connect Tailscale first, then re-run"
			continue
		fi

		LOCAL="" REMOTE=""
		# shellcheck source=/dev/null
		source "$BISYNC_DIR/${name}.env"

		if [[ -z "${LOCAL:-}" || -z "${REMOTE:-}" ]]; then
			warn "$name: missing LOCAL or REMOTE in ${name}.env, skipping"
			continue
		fi

		info "Resyncing $name: $LOCAL ↔ $REMOTE"
		if auto-bisync "$LOCAL" "$REMOTE" resync; then
			check_done "Bisync resync ($name) complete"
		else
			warn "$name: resync failed"
		fi
	fi
done

# ── Step 7+: Bisync services (per config) ────────────────────────────────────
for name in "${BISYNC_CONFIGS[@]}"; do
	if is_bisync_service_enabled "$name"; then DONE=true; else DONE=false; fi
	if ask_step "$DONE" "Enable bisync service: ${name}" "Bisync service ($name) (enabled)"; then
		step_header "Enable bisync service: $name"
		if ! is_bisync_resynced; then
			warn "Bisync not initialized — run initial resync first"
		else
			info "Enabling bisync@${name}.service..."
			systemctl --user enable --now "bisync@${name}.service"
			check_done "bisync@${name}.service enabled (continuous sync)"
		fi
	fi
done

# ── Summary ───────────────────────────────────────────────────────────────────
echo ""
info "Setup wizard complete."
show_status

{{- else }}
echo "Skipping init wizard (not Linux or headless)"
{{- end }}
