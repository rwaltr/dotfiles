#!/usr/bin/env python3
# Inspired by Zena-Linux's virtualization script:
# https://github.com/Zena-Linux/Zena/blob/main/system-files/base/usr/local/bin/virtualization

import os
import sys
import subprocess

CONTAINER_NAME = "Virtualization"
IMAGE = "ghcr.io/zena-linux/virtualization:latest"


def run(cmd, *, env=None, check=True):
    """Run a command with list arguments, print it, raise on error."""
    print("Running:", " ".join(cmd))
    subprocess.run(cmd, env=env, check=check)


def container_exists(name):
    """Return True if a Podman container with this name exists."""
    try:
        result = subprocess.run(
            ["pkexec", "podman", "ps", "-a", "--format", "{{.Names}}"],
            capture_output=True,
            text=True,
            check=True,
        )
        return name in result.stdout.splitlines()
    except subprocess.CalledProcessError:
        return False


def install():
    username = os.getlogin()
    uid = os.getuid()
    gid = os.getgid()

    if container_exists(CONTAINER_NAME):
        print(f"Container '{CONTAINER_NAME}' already exists - skipping install.")
        return

    print(f"Creating distrobox container {CONTAINER_NAME} from {IMAGE}")

    run([
        "distrobox", "create",
        "--name", CONTAINER_NAME,
        "--image", IMAGE,
        "--pull",
        "--root",
        "--init",
        "--unshare-netns",
        "--pre-init-hooks",
        (
            f"groupadd -f -g {gid} {username} || true; "
            f"useradd -m -u {uid} -g {gid} -s /bin/bash {username} || true"
        ),
        "--init-hooks",
        (
            f"usermod -aG libvirt {username} || true"
        ),
    ])

    print("Please run `virtcontainerctl enter` to initialize")


def upgrade():
    if not container_exists(CONTAINER_NAME):
        print(f"Container '{CONTAINER_NAME}' does not exist - cannot upgrade.")
        return

    print(f"Upgrading container '{CONTAINER_NAME}'...")
    run(["distrobox", "upgrade", "--root", CONTAINER_NAME])
    print("Upgrade complete!")


def enter():
    if not container_exists(CONTAINER_NAME):
        print(f"Container '{CONTAINER_NAME}' does not exist - cannot enter.")
        return

    print(f"Entering container '{CONTAINER_NAME}'...")
    os.execvp("distrobox", ["distrobox", "enter", "--root", CONTAINER_NAME])


def uninstall():
    if not container_exists(CONTAINER_NAME):
        print(f"Container '{CONTAINER_NAME}' does not exist.")
        return

    print(f"Removing distrobox container {CONTAINER_NAME}...")
    run(["distrobox", "rm", "--root", "-f", CONTAINER_NAME])
    print("Done.")


def usage():
    print(f"Usage: {sys.argv[0]} {{install|upgrade|enter|uninstall}}")
    sys.exit(1)


if __name__ == "__main__":
    env = os.environ.copy()
    env["DBX_SUDO_PROGRAM"] = "pkexec"

    if len(sys.argv) != 2:
        usage()

    cmd = sys.argv[1].lower()
    if cmd == "install":
        install()
    elif cmd == "upgrade":
        upgrade()
    elif cmd == "enter":
        enter()
    elif cmd == "uninstall":
        uninstall()
    else:
        usage()
