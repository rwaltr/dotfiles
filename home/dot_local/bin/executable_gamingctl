#!/usr/bin/env python3
# Inspired by Zena-Linux's gaming script:
# https://github.com/Zena-Linux/Zena/blob/main/system-files/base/usr/local/bin/gaming

import argparse
import os
import subprocess
import sys

CONTAINER_NAME = "Gaming"
IMAGE = "docker.io/cachyos/cachyos-v3:latest"


def run(cmd, *, env=None, check=True):
    """Run a command with list arguments, print it, raise on error."""
    print("Running:", " ".join(cmd))
    subprocess.run(cmd, env=env, check=check)


def container_exists(name):
    """Return True if a Podman container with this name exists."""
    try:
        result = subprocess.run(
            ["podman", "ps", "-a", "--format", "{{.Names}}"],
            capture_output=True,
            text=True,
            check=True,
        )
        return name in result.stdout.splitlines()
    except subprocess.CalledProcessError:
        return False


def has_nvidia_gpu():
    """Return True if `nvidia-smi` runs successfully."""
    try:
        subprocess.run(
            ["nvidia-smi"],
            stdout=subprocess.DEVNULL,
            stderr=subprocess.DEVNULL,
            check=True,
        )
        print("NVIDIA GPU detected - enabling GPU support")
        return True
    except Exception:
        return False


def install(extra_dirs=None):
    if container_exists(CONTAINER_NAME):
        print(f"Container '{CONTAINER_NAME}' already exists - skipping install.")
        return

    nvidia_flag = ["--nvidia"] if has_nvidia_gpu() else []

    print(f"Creating distrobox container {CONTAINER_NAME} from {IMAGE}")

    # Auto-detect default Steam library
    volumes = []
    steam_lib = f"/media/ssdcache/{os.getlogin()}/games"
    if os.path.isdir(steam_lib):
        print(f"Found Steam library at {steam_lib} â€” mounting into container")
        volumes += ["--volume", f"{steam_lib}:{steam_lib}:rslave"]

    # Extra volumes from --volume args
    for d in (extra_dirs or []):
        d = os.path.realpath(d)
        if os.path.isdir(d):
            print(f"Mounting extra volume: {d}")
            volumes += ["--volume", f"{d}:{d}:rslave"]
        else:
            print(f"Warning: {d} does not exist, skipping")

    run([
        "distrobox", "create",
        "--name", CONTAINER_NAME,
        "--image", IMAGE,
        "--pull",
        *nvidia_flag,
        *volumes,
        "--yes",
    ])

    print("Installing gaming packages...")
    run([
        "distrobox", "enter", CONTAINER_NAME,
        "--", "sudo", "pacman",
        "-Syu", "--noconfirm",
    ])

    pkgs = [
        "cachyos-gaming-meta",
        "cachyos-gaming-applications",
        "umu-launcher",
        "protonup-qt",
    ]

    run([
        "distrobox", "enter", CONTAINER_NAME,
        "--", "sudo", "pacman",
        "-S", "--noconfirm",
        *pkgs,
    ])

    print("Exporting apps to host...")
    desktop_files = [
        "/usr/share/applications/heroic.desktop",
        "/usr/share/applications/io.github.benjamimgois.goverlay.desktop",
        "/usr/share/applications/net.davidotek.pupgui2.desktop",
        "/usr/share/applications/net.lutris.Lutris.desktop",
        "/usr/share/applications/steam.desktop",
    ]

    for file in desktop_files:
        run([
            "distrobox", "enter", CONTAINER_NAME,
            "--", "distrobox-export",
            "--app", file,
        ])

    print("Exporting binary launchers to host...")
    bin_paths = [
        "/usr/bin/heroic",
        "/usr/bin/lutris",
        "/usr/bin/steam",
    ]

    for path in bin_paths:
        run([
            "distrobox", "enter", CONTAINER_NAME,
            "--", "distrobox-export",
            "--bin", path,
        ])


def upgrade():
    if not container_exists(CONTAINER_NAME):
        print(f"Container '{CONTAINER_NAME}' does not exist - cannot upgrade.")
        return

    print(f"Upgrading container '{CONTAINER_NAME}'...")
    run(["distrobox", "upgrade", CONTAINER_NAME])
    print("Upgrade complete!")


def enter():
    if not container_exists(CONTAINER_NAME):
        print(f"Container '{CONTAINER_NAME}' does not exist - cannot enter.")
        return

    print(f"Entering container '{CONTAINER_NAME}'...")
    os.execvp("distrobox", ["distrobox", "enter", CONTAINER_NAME])


def uninstall():
    if not container_exists(CONTAINER_NAME):
        print(f"Container '{CONTAINER_NAME}' does not exist.")
        return

    print(f"Removing distrobox container {CONTAINER_NAME}...")
    run(["distrobox", "rm", "-f", CONTAINER_NAME])
    print("Done.")


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Manage the Gaming distrobox container")
    subparsers = parser.add_subparsers(dest="cmd", required=True)

    p_install = subparsers.add_parser("install", help="Create and set up the container")
    p_install.add_argument(
        "-v", "--volume", dest="volumes", action="append", default=[],
        metavar="DIR", help="Extra directory to mount (can be repeated)",
    )

    subparsers.add_parser("upgrade", help="Upgrade the container and packages")
    subparsers.add_parser("enter", help="Enter the container shell")
    subparsers.add_parser("uninstall", help="Remove the container")

    args = parser.parse_args()

    if args.cmd == "install":
        install(extra_dirs=args.volumes)
    elif args.cmd == "upgrade":
        upgrade()
    elif args.cmd == "enter":
        enter()
    elif args.cmd == "uninstall":
        uninstall()
