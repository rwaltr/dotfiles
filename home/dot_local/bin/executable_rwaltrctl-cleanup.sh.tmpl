#!/usr/bin/env bash
# vi: ft=sh
# rwaltrctl-cleanup — undo everything chezmoi apply installs/configures.
# Restores the system to pre-chezmoi state (without removing chezmoi itself).
#
# Usage:
#   rwaltrctl-cleanup          # interactive — prompts before each phase
#   rwaltrctl-cleanup --force  # no prompts — run everything

set -euo pipefail

FORCE=false
[[ "${1:-}" == "--force" ]] && FORCE=true

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

info()  { echo -e "${GREEN}[cleanup]${NC} $*"; }
warn()  { echo -e "${YELLOW}[cleanup]${NC} $*"; }
error() { echo -e "${RED}[cleanup]${NC} $*" >&2; }

confirm() {
	if $FORCE; then return 0; fi
	local msg="$1"
	read -rp "$(echo -e "${YELLOW}$msg [y/N]${NC} ")" answer
	[[ "$answer" =~ ^[Yy] ]]
}

# ── Phase 1: Stop systemd user units ─────────────────────────────────────────
phase_systemd() {
	info "Phase 1: Stopping chezmoi-managed systemd user units..."
	if ! command -v systemctl &>/dev/null; then
		warn "systemctl not found, skipping"
		return
	fi

	local units=(
		"resticprofile@home.timer"
		"bisync@.service"
	)
	for unit in "${units[@]}"; do
		if systemctl --user is-enabled "$unit" &>/dev/null; then
			info "  Disabling $unit"
			systemctl --user disable --now "$unit" 2>/dev/null || true
		fi
		if systemctl --user is-active "$unit" &>/dev/null; then
			info "  Stopping $unit"
			systemctl --user stop "$unit" 2>/dev/null || true
		fi
	done
	systemctl --user daemon-reload
}

# ── Phase 2: Remove OrcaSlicer flatpak + bundle ──────────────────────────────
phase_orcaslicer() {
	info "Phase 2: Removing OrcaSlicer..."
	if ! command -v flatpak &>/dev/null; then
		warn "flatpak not found, skipping"
		return
	fi

	if flatpak info --user io.github.softfever.OrcaSlicer &>/dev/null; then
		info "  Uninstalling OrcaSlicer (user)"
		flatpak uninstall -y --noninteractive --user io.github.softfever.OrcaSlicer
	fi

	local bundle="{{ .chezmoi.homeDir }}/.local/share/flatpak-bundles/orcaslicer.flatpak"
	if [[ -f "$bundle" ]]; then
		info "  Removing cached bundle"
		rm -f "$bundle"
		rmdir --ignore-fail-on-non-empty "$(dirname "$bundle")" 2>/dev/null || true
	fi
}

# ── Phase 3: Remove declared flatpaks ─────────────────────────────────────────
phase_flatpaks() {
	info "Phase 3: Removing chezmoi-declared flatpaks..."
	if ! command -v flatpak &>/dev/null; then
		warn "flatpak not found, skipping"
		return
	fi

	local -a declared
	mapfile -t declared < <(cat << 'EOF' | grep -v '^\s*#' | grep -v '^\s*$'
{{ template "flatpaks.txt" . }}
EOF
	)

	if [[ ${#declared[@]} -eq 0 ]]; then
		warn "  No flatpaks declared, skipping"
		return
	fi

	info "  Removing ${#declared[@]} flatpaks..."
	for app in "${declared[@]}"; do
		if flatpak info "$app" &>/dev/null; then
			info "    Removing $app"
			flatpak uninstall -y --noninteractive "$app" 2>/dev/null || true
		fi
	done

	# Remove 1Password flatpak user overrides
	if command -v flatpak &>/dev/null; then
		info "  Resetting 1Password flatpak overrides"
		flatpak override --user --reset com.onepassword.OnePassword 2>/dev/null || true
	fi

	# Clean unused runtimes
	info "  Cleaning unused runtimes..."
	flatpak uninstall -y --noninteractive --unused 2>/dev/null || true
}

# ── Phase 4: Remove mise-installed tools ──────────────────────────────────────
phase_mise() {
	info "Phase 4: Removing mise-installed tools (from chezmoi config)..."
	if ! command -v mise &>/dev/null; then
		warn "mise not found, skipping"
		return
	fi

	# Only uninstall tools declared in the chezmoi-managed mise config
	local config="{{ .chezmoi.homeDir }}/.config/mise/config.toml"
	if [[ -f "$config" ]]; then
		info "  Pruning tools from $config"
		mise uninstall --all --yes 2>/dev/null || true
	fi
}

# ── Phase 5: Remove brew packages ────────────────────────────────────────────
phase_brew() {
	info "Phase 5: Removing brew bundle packages..."
	if ! command -v brew &>/dev/null; then
		{{ if eq .chezmoi.os "linux" -}}
		if [[ -x /home/linuxbrew/.linuxbrew/bin/brew ]]; then
			eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
		else
			warn "brew not found, skipping"
			return
		fi
		{{- else }}
		warn "brew not found, skipping"
		return
		{{- end }}
	fi

	local brewfile
	brewfile=$(mktemp)
	trap 'rm -f "$brewfile"' RETURN

	cat > "$brewfile" << 'BREWFILE_EOF'
{{ template "Brewfile" . }}
BREWFILE_EOF

	info "  Running brew bundle cleanup (zap removes packages)..."
	brew bundle cleanup --file="$brewfile" --force --zap 2>/dev/null || true

	# Explicitly uninstall each formula/cask from the Brewfile
	local -a formulas casks
	mapfile -t formulas < <(grep -E '^\s*brew ' "$brewfile" | sed 's/.*"\(.*\)".*/\1/')
	mapfile -t casks < <(grep -E '^\s*cask ' "$brewfile" | sed 's/.*"\(.*\)".*/\1/')

	for f in "${formulas[@]}"; do
		if brew list --formula "$f" &>/dev/null; then
			info "    Removing formula: $f"
			brew uninstall --formula "$f" 2>/dev/null || true
		fi
	done

	for c in "${casks[@]}"; do
		if brew list --cask "$c" &>/dev/null; then
			info "    Removing cask: $c"
			brew uninstall --cask "$c" 2>/dev/null || true
		fi
	done

	# Clean up
	brew autoremove 2>/dev/null || true
	brew cleanup --prune=all 2>/dev/null || true
}

# ── Phase 6: Remove chezmoi-managed dotfiles ──────────────────────────────────
phase_dotfiles() {
	info "Phase 6: Removing chezmoi-managed dotfiles..."

	# Use chezmoi's own purge to remove managed targets (but keep source state)
	# We manually remove managed files to preserve ~/.local/share/chezmoi
	local -a managed
	mapfile -t managed < <(chezmoi managed --path-style=absolute 2>/dev/null | \
		grep -v '\.chezmoiscripts' | \
		sort -r)  # reverse so files before dirs

	if [[ ${#managed[@]} -eq 0 ]]; then
		warn "  No managed files found"
		return
	fi

	info "  Removing ${#managed[@]} managed files/dirs..."
	for target in "${managed[@]}"; do
		if [[ -L "$target" ]]; then
			info "    rm symlink: $target"
			rm -f "$target"
		elif [[ -f "$target" ]]; then
			info "    rm file: $target"
			rm -f "$target"
		elif [[ -d "$target" ]]; then
			# Only remove if empty (children already removed due to reverse sort)
			rmdir "$target" 2>/dev/null && info "    rmdir: $target" || true
		fi
	done
}

# ── Phase 7: Reset chezmoi script state ───────────────────────────────────────
phase_chezmoi_state() {
	info "Phase 7: Clearing chezmoi run_once/run_onchange state..."
	chezmoi state delete-bucket --bucket=entryState 2>/dev/null || true
	chezmoi state delete-bucket --bucket=scriptState 2>/dev/null || true
	info "  Done — next 'chezmoi apply' will re-run all scripts"
}

# ══════════════════════════════════════════════════════════════════════════════
# Main
# ══════════════════════════════════════════════════════════════════════════════

echo ""
echo -e "${RED}╔══════════════════════════════════════════════════════╗${NC}"
echo -e "${RED}║          rwaltrctl-cleanup — DESTRUCTIVE              ║${NC}"
echo -e "${RED}║  This will undo everything chezmoi apply has done.   ║${NC}"
echo -e "${RED}║  chezmoi source state is preserved.                  ║${NC}"
echo -e "${RED}╚══════════════════════════════════════════════════════╝${NC}"
echo ""

if ! $FORCE; then
	confirm "Proceed with cleanup?" || { info "Aborted."; exit 0; }
	echo ""
fi

confirm "Phase 1: Stop systemd user units?"           && phase_systemd
echo ""
confirm "Phase 2: Remove OrcaSlicer flatpak + bundle?" && phase_orcaslicer
echo ""
confirm "Phase 3: Remove all declared flatpaks?"       && phase_flatpaks
echo ""
confirm "Phase 4: Remove mise-installed tools?"        && phase_mise
echo ""
confirm "Phase 5: Remove brew packages?"               && phase_brew
echo ""
confirm "Phase 6: Remove chezmoi-managed dotfiles?"    && phase_dotfiles
echo ""
confirm "Phase 7: Clear chezmoi script state?"         && phase_chezmoi_state

echo ""
info "Cleanup complete."
info "Source state preserved at: {{ .chezmoi.sourceDir }}"
info "Run 'chezmoi apply' to restore everything."
