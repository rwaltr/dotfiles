#!/usr/bin/env bash
# auto-bisync — inotify-driven continuous bisync between a local path and an rclone remote
#
# Usage:
#   auto-bisync <local-path> <remote>                  # watch continuously
#   auto-bisync <local-path> <remote> once             # single bisync run then exit
#   auto-bisync <local-path> <remote> resync           # force --resync (first-time / recovery)
#
# Examples:
#   auto-bisync ~/Documents :sftp,host=mouse:Documents
#   auto-bisync ~/Documents :sftp,host=mouse:Documents resync
#
# Requirements: rclone, inotify-tools
# SSH auth via 1Password agent socket
# Backup dirs: ~/.local/share/bisync-backups/<local-path-slug>/{local,remote}

set -euo pipefail

# ── Args ──────────────────────────────────────────────────────────────────────
if [[ $# -lt 2 ]]; then
    echo "Usage: $(basename "$0") <local-path> <remote> [watch|once|resync]"
    exit 1
fi

LOCAL="$(realpath "$1")"
REMOTE="$2"
CMD="${3:-watch}"

# ── Config ────────────────────────────────────────────────────────────────────
SSH_SOCK="${HOME}/.1password/agent.sock"
# Backup dirs must be outside the sync source — use a stable name derived from the local path
_SAFE_NAME="$(echo "$LOCAL" | tr '/' '_' | sed 's/^_//')"
BACKUP_LOCAL="${HOME}/.local/share/bisync-backups/${_SAFE_NAME}/local"
BACKUP_REMOTE="${HOME}/.local/share/bisync-backups/${_SAFE_NAME}/remote"

WATCH_EVENTS="modify,delete,create,move"
SYNC_DELAY=5        # seconds to wait after a change before syncing (debounce)
SYNC_INTERVAL=3600  # seconds between forced syncs even with no changes

# ── Helpers ───────────────────────────────────────────────────────────────────
log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"; }

notify() {
    local msg="$1"
    if command -v notify-send &>/dev/null && [[ -n "${DBUS_SESSION_BUS_ADDRESS:-}" ]]; then
        notify-send "auto-bisync" "$msg" --icon=emblem-synchronizing 2>/dev/null || true
    fi
}

bisync() {
    local extra_flags=("$@")
    log "Running bisync: $LOCAL ↔ $REMOTE"
    SSH_AUTH_SOCK="$SSH_SOCK" rclone bisync \
        "$LOCAL" "$REMOTE" \
        --create-empty-src-dirs \
        --backup-dir1 "$BACKUP_LOCAL" \
        --backup-dir2 "$BACKUP_REMOTE" \
        --compare size,modtime \
        --resilient \
        --verbose \
        "${extra_flags[@]}"
}

# ── Commands ──────────────────────────────────────────────────────────────────
case "$CMD" in
resync)
    log "Running initial resync..."
    bisync --resync
    log "Resync complete"
    ;;

once)
    bisync
    log "Sync complete"
    ;;

watch)
    log "Starting continuous sync: $LOCAL ↔ $REMOTE"
    log "Watching for changes (debounce: ${SYNC_DELAY}s, forced interval: ${SYNC_INTERVAL}s)"

    # Initial sync on startup
    bisync && notify "Started ($LOCAL)" || { notify "Startup sync failed ($LOCAL)"; log "Startup sync failed"; }

    while true; do
        if inotifywait \
            --recursive \
            --timeout "$SYNC_INTERVAL" \
            --event "$WATCH_EVENTS" \
            --exclude '/\.git/' \
            "$LOCAL" 2>/dev/null; then
            # File change detected — debounce then sync
            log "Change detected, waiting ${SYNC_DELAY}s..."
            sleep "$SYNC_DELAY"
            bisync && notify "Synchronized ($LOCAL)" || { notify "Sync failed ($LOCAL)"; log "Sync failed"; }
        else
            exit_code=$?
            if [[ $exit_code -eq 2 ]]; then
                # Timeout — forced interval sync
                log "Interval sync triggered"
                bisync || { notify "Interval sync failed ($LOCAL)"; log "Interval sync failed"; }
            else
                log "inotifywait error (exit $exit_code), retrying in 10s..."
                sleep 10
            fi
        fi
    done
    ;;

*)
    echo "Usage: $(basename "$0") <local-path> <remote> [watch|once|resync]"
    exit 1
    ;;
esac
