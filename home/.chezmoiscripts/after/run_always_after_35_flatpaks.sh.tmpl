#!/usr/bin/env bash
# vi: ft=sh
# Sync flatpaks — install declared apps, remove apps no longer declared.
# flatpak install --or-update is idempotent; run on every chezmoi apply.
# Linux only — skipped entirely on macOS.

{{ if (and (eq .chezmoi.os "linux") (not .headless)) -}}
set -euo pipefail

if ! command -v flatpak &>/dev/null; then
	echo "flatpak not available, skipping"
	exit 0
fi

# Build declared list from template — strip comments and blank lines
mapfile -t DECLARED < <(cat << 'EOF' | grep -v '^\s*#' | grep -v '^\s*$'
{{ template "flatpaks.txt" . }}
EOF
)

if [[ ${#DECLARED[@]} -gt 0 ]]; then
	echo "Installing/updating ${#DECLARED[@]} flatpaks..."
	flatpak install -y --noninteractive --or-update flathub "${DECLARED[@]}"
fi

# Remove flatpaks that are installed but no longer declared
# Only consider user-installed apps (skip runtimes — flatpak manages those)
mapfile -t INSTALLED < <(flatpak list --app --columns=application 2>/dev/null)

for app in "${INSTALLED[@]}"; do
	if [[ -z "$app" ]]; then continue; fi
	# Skip OrcaSlicer — managed separately by run_always_after_36
	if [[ "$app" == "io.github.softfever.OrcaSlicer" ]]; then continue; fi
	if ! printf '%s\n' "${DECLARED[@]}" | grep -qx "$app"; then
		echo "Removing unlisted flatpak: $app"
		flatpak uninstall -y --noninteractive "$app"
	fi
done

# Clean up unused runtimes
flatpak uninstall -y --noninteractive --unused 2>/dev/null || true
{{- else }}
echo "Skipping flatpaks (not Linux or headless)"
{{- end }}
