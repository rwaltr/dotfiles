#!/usr/bin/env bash
# vi: ft=sh
# Install OrcaSlicer from the .flatpak bundle fetched by .chezmoiexternal.yaml.
# OrcaSlicer has no Flathub remote — ships its own bundle per GitHub release.
# chezmoi handles download + caching + re-fetch on new version (refreshPeriod: 168h).
# run_onchange — reruns when the bundle URL changes (i.e. new release).
#
# bundle url: {{ gitHubLatestReleaseAssetURL "SoftFever/OrcaSlicer" "OrcaSlicer-Linux-flatpak_*_x86_64.flatpak" }}

{{ if (and (eq .chezmoi.os "linux") (not .headless) .personal) -}}
set -euo pipefail

BUNDLE="{{ .chezmoi.homeDir }}/.local/share/flatpak-bundles/orcaslicer.flatpak"

if ! command -v flatpak &>/dev/null; then
	echo "flatpak not available, skipping OrcaSlicer"
	exit 0
fi

if [[ ! -f "$BUNDLE" ]]; then
	echo "OrcaSlicer bundle not found at $BUNDLE — chezmoi external may not have run yet"
	exit 1
fi

echo "Installing OrcaSlicer from $BUNDLE..."
flatpak install -y --noninteractive "$BUNDLE"
echo "OrcaSlicer installed"
{{- else }}
echo "Skipping OrcaSlicer (not Linux, headless, or not personal)"
{{- end }}
