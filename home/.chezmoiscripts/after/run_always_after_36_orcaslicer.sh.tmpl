#!/usr/bin/env bash
# vi: ft=sh
# Download & install OrcaSlicer from the .flatpak bundle on GitHub releases.
# OrcaSlicer has no Flathub remote — ships its own bundle per GitHub release.
# Self-contained: handles download + caching + install in one script.
# flatpak install --user is idempotent; run_always fires on every chezmoi apply.

{{ if (and (eq .chezmoi.os "linux") (not .headless) .personal) -}}
set -euo pipefail

{{- $arch := "x86_64" }}
{{- if eq .chezmoi.arch "arm64" }}{{- $arch = "aarch64" }}{{- end }}
{{- $assetURL := gitHubLatestReleaseAssetURL "SoftFever/OrcaSlicer" (printf "OrcaSlicer-Linux-flatpak_*_%s.flatpak" $arch) }}
{{- $bundleVer := $assetURL | base | trimPrefix "OrcaSlicer-Linux-flatpak_V" | splitList "_" | first }}

BUNDLE_DIR="{{ .chezmoi.homeDir }}/.local/share/flatpak-bundles"
BUNDLE="${BUNDLE_DIR}/orcaslicer.flatpak"
BUNDLE_URL={{ $assetURL | quote }}
BUNDLE_VER={{ $bundleVer | quote }}

if ! command -v flatpak &>/dev/null; then
	echo "flatpak not available, skipping OrcaSlicer"
	exit 0
fi

# Get installed version
INSTALLED_VER=$(flatpak info --user io.github.softfever.OrcaSlicer 2>/dev/null | grep "Version" | awk '{print $2}' || true)
INSTALLED_VER="${INSTALLED_VER:-$(flatpak info --system io.github.softfever.OrcaSlicer 2>/dev/null | grep "Version" | awk '{print $2}' || true)}"

if [[ -n "$INSTALLED_VER" && "$INSTALLED_VER" == *"$BUNDLE_VER"* ]]; then
	echo "OrcaSlicer $INSTALLED_VER already installed and current, skipping"
	exit 0
fi

# Download bundle if missing or version changed
mkdir -p "$BUNDLE_DIR"
if [[ ! -f "$BUNDLE" ]] || [[ -n "$INSTALLED_VER" && "$INSTALLED_VER" != *"$BUNDLE_VER"* ]]; then
	echo "Downloading OrcaSlicer $BUNDLE_VER..."
	curl -fsSL -o "${BUNDLE}.tmp" "$BUNDLE_URL"
	mv "${BUNDLE}.tmp" "$BUNDLE"
fi

if [[ -n "$INSTALLED_VER" ]]; then
	echo "Updating OrcaSlicer $INSTALLED_VER → $BUNDLE_VER..."
	flatpak install -y --noninteractive --user --reinstall "$BUNDLE"
else
	echo "Installing OrcaSlicer $BUNDLE_VER..."
	flatpak install -y --noninteractive --user "$BUNDLE"
fi
echo "OrcaSlicer $BUNDLE_VER installed"
{{- else }}
echo "Skipping OrcaSlicer (not Linux, headless, or not personal)"
{{- end }}
