#!/usr/bin/env bash
# vi: ft=sh
# Grant the 1Password flatpak access to the op-daemon and SSH agent sockets
# so that `op` CLI on the host can authenticate via the GUI (biometric/unlock-once).
#
# Without these overrides the flatpak sandbox blocks the sockets and `op` always
# prompts for the master password.
#
# run_onchange — reruns if this script changes (effectively run_once in practice).

{{ if eq .chezmoi.os "linux" -}}
set -euo pipefail

APP="com.onepassword.OnePassword"

if ! command -v flatpak &>/dev/null; then
	echo "flatpak not available, skipping 1Password overrides"
	exit 0
fi

if ! flatpak info "$APP" &>/dev/null; then
	echo "1Password flatpak not installed yet, skipping overrides"
	exit 0
fi

echo "Applying 1Password flatpak socket overrides..."

# /run/user/$UID/op-daemon.sock — CLI unlock daemon
flatpak override --user \
	--filesystem=xdg-run/op-daemon.sock \
	"$APP"

# ~/.1password/agent.sock — SSH agent
flatpak override --user \
	--filesystem=~/.1password \
	"$APP"

echo "Done. Verify with: flatpak override --user --show $APP"
{{- else }}
echo "Not Linux, skipping 1Password flatpak overrides"
{{- end }}
